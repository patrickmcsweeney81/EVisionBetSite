# EV Bot ‚Äì Sports Betting Expected Value Finder

This bot scans sports betting odds from multiple bookmakers using The Odds API and identifies expected value (EV) opportunities. Arbitrage logic was removed; focus is EV-only.

Fair price calculation now uses a single unified weighting system via `core/book_weights.py` (v2.0). All active handlers (H2H, spreads, totals, player props, NFL props) have migrated to the weighted median model. Legacy percentage functions remain only for backward compatibility and will be removed after validation. See `BOOK_WEIGHTS_INTEGRATION.md` for full details.

## How It Works
- Fetches odds for selected sports and markets from The Odds API
- Calculates fair prices using sharp bookmakers (Pinnacle, DK/FD, BetOnline, Betfair)
- Adjusts Betfair odds for commission (default: 6%)
   - v2.0: Uses 0‚Äì4 weight scale with sport-specific overrides (props-heavy for NBA/NFL)
   - Legacy: Percentage-based model favoring Pinnacle remains available
- Detects: **EV hits** only (arbitrage support has been removed)
- Logs results to `data/hits_log.csv` and deduplicates using `data/seen_hits.json`

## Configuration
All settings are controlled via the `.env` file. Inline comments after `#` are stripped automatically for numeric values.

Note: No `.env` changes are required to use the v2.0 book weights system. Migration is COMPLETE for main and props markets; legacy functions are dormant unless explicitly called in older scripts/tests.

```
ODDS_API_KEY=YOUR_KEY            # Required: Odds API key
ODDS_API_BASE=https://api.the-odds-api.com/v4
REGIONS=au,us                    # Base regions; API_TIER may override
MARKETS=h2h,spreads,totals       # Comma list (props added automatically per sport unless API_TIER=low)
SPORTS=basketball_nba            # Comma list of sport keys or 'upcoming'
API_TIER=medium                  # low|medium|high (low disables props; high adds 'eu' region)
INCLUDE_US_BOOKS=0               # 1 to include mass‚Äëmarket US books in ACTIVE_BOOKIES
EV_MIN_EDGE=0.03                 # Minimum EV edge threshold
MIN_PROB=0.20                    # Minimum fair probability to keep (if prob filter enabled)
MIN_STAKE=5                      # Minimum Kelly stake to log (USD)
BETFAIR_COMMISSION=0.06          # Betfair commission
BANKROLL=1000                    # Bankroll for Kelly sizing
KELLY_FRACTION=0.25              # Fractional Kelly
MIN_TIME_TO_START_MINUTES=3      # Skip events starting sooner than this
MAX_TIME_TO_START_HOURS=24       # Skip events starting later than this
STALE_EVENT_HOURS=24             # Do not process events whose start time is > this past window
REFRESH_EVENT_MINUTES=30         # Do not re-log same event within this recency window
TELEGRAM_ENABLED=0               # 1=enable Telegram alerts
TELEGRAM_BOT_TOKEN=
TELEGRAM_CHAT_ID=
TELEGRAM_DEBUG=0
SUMMARY_ENABLED=0                # 1=send post-run summary
EV_MAX_ALERTS=0                  # 0=unlimited; else cap EV hit alerts
FILTER_BOOKS=                    # Optional override subset of books
FILTER_SPORTS=                   # Optional override subset of sports
TEST_ALLOW_DUPES=0               # 1=disable dedupe (testing only)
```

## Thresholds & Key Points
- **EV_MIN_EDGE**: Edge computed as `(fair_prob * book_odds - 1)`; only edges ‚â• threshold logged when filter enabled.
- **Probability Filter (MIN_PROB)**: Suppresses very long-shot edges if `ENABLE_PROB_FILTER` is true in code.
- **Kelly Sizing**: Stake = fractional Kelly on fair odds vs book odds; rounded to nearest $5.
- **API_TIER**: Adaptive: low (AU only, no props), medium (AU+US, props on), high (AU+US+EU, props on).
- **INCLUDE_US_BOOKS**: Adds 15 US mass-market books to the ACTIVE_BOOKIES set for logging/comparison.
- **Event Cache**: `cache_events.json` prevents reprocessing recent events (REFRESH_EVENT_MINUTES) and skipping stale starts (STALE_EVENT_HOURS).
- **Sharp Inputs**: Fair price modules prioritize Pinnacle; Betfair commission applied before weighting.

Fair Price Model (Unified):
- `core/fair_prices.py` functions `build_fair_price_from_books` and `build_fair_prices_two_way` using `core/book_weights.py` (0‚Äì4 scale, sport/market aware).
Legacy (Deprecated): `master_fair_odds` and `build_fair_prices_simple` kept temporarily for old tests; not used in current handlers.

## Output Files
- `data/all_odds_analysis.csv`: Comprehensive raw+fair odds snapshot (primary source for filtering).
- `data/all_odds.csv`: Filtered EV summary (generated by post-processing script).
- `data/seen_hits.json`: Deduplication store to suppress repeat opportunities.
- `data/cache_events.json`: Disk-backed event last-seen timestamps for cross-run caching.
- `data/api_usage.json`: Per-run aggregated API usage metrics (sports calls, skipped counts, etc.).

## Running the Bot
1. Create/modify `.env` with required keys (see above).
2. Install dependencies:
   ```powershell
   pip install requests python-dotenv
   ```

3. Run the bot (main entry point):
   ```powershell
   python ev_arb_bot.py
   ```
4. (Optional) Generate filtered EV summary via your filter script (`filter_ev_hits.py`).
5. Inspect `data/all_odds_analysis.csv` & `data/all_odds.csv`.

## Running Tests
Tests are standardized to use `pytest`. To run all tests:
```powershell
pytest
```
Or use the Python Test Explorer extension in VS Code for a graphical interface.

All test files are in the `tests/` directory and follow the `test_*.py` naming convention.

## Customization
- Sports: set `SPORTS=basketball_nba,americanfootball_nfl` etc.
- Add/Remove books: edit `core/config.py` (`AU_BOOKIES`, `US_BOOKIES`, `SHARP_BOOKIES`).
- Enable US books: `INCLUDE_US_BOOKS=1`.
- Tighten region usage via `API_TIER` rather than manual `REGIONS` changes.
- Tune scanning cadence / reprocessing with `REFRESH_EVENT_MINUTES` and `STALE_EVENT_HOURS`.

## Telegram Alerts
- If `TELEGRAM_BOT_TOKEN` and `TELEGRAM_CHAT_ID` are set and `TELEGRAM_ENABLED!=0`, the bot sends a message for each EV hit in this format:

   ```
   üî• Pats EV Bot üî• EV +2.9%
   Monaco V Valencia
   üèÄ Basketball    H2H
   Sat Oct 18, 01:30AM (local time)
   H2H
   Valencia ‚Ä¢ Unibet $3.55
   Stake = $12.34
   Fair = $3.45     Prob 29.0%
   ```

- Stake is computed using fractional Kelly on `BANKROLL` and `KELLY_FRACTION` with a fallback of `STAKE_FALLBACK`.

## Summary Messages
- If `SUMMARY_ENABLED=1`, a per-run summary is sent to Telegram after the scan, showing EV count and total hits.

## Launcher Usage
- Run normally (uses `.env`):
   ```bat
   launcher.bat
   ```
- Disable Telegram for a run:
   ```bat
   launcher.bat --no-telegram
   ```
- Explicitly enable Telegram:
   ```bat
   launcher.bat --telegram-on
   ```

## Notes
- CSV policy: Only `all_odds_analysis.csv` + `all_odds.csv` retained; legacy EV CSVs are cleaned automatically.
- Timestamps in CSV are UTC; adjust locally for display.
- Disk cache accelerates repeated runs and reduces API calls.
- Inline numeric env values may include trailing comments (parser trims after `#`).
- For deeper architecture notes see `.github/copilot-instructions.md` and source docstrings in `core/`.
